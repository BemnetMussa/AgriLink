// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model
model User {
  id            String    @id @default(uuid())
  phoneNumber   String    @unique
  email         String?   @unique
  passwordHash  String?
  firstName     String
  lastName      String
  role          UserRole  @default(BUYER)
  language      Language  @default(ENGLISH)
  isVerified    Boolean   @default(false)
  isActive      Boolean   @default(true)
  avatar        String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  farmerProfile    FarmerProfile?
  buyerProfile     BuyerProfile?
  products         Product[]
  ordersAsBuyer    Order[]         @relation("BuyerOrders")
  ordersAsFarmer   Order[]         @relation("FarmerOrders")
  sentMessages     Message[]       @relation("SenderMessages")
  receivedMessages Message[]       @relation("ReceiverMessages")
  sentReviews      Review[]        @relation("ReviewerReviews")
  receivedReviews  Review[]        @relation("ReviewedUserReviews")
  notifications    Notification[]
  refreshTokens    RefreshToken[]
  otpCodes         OtpCode[]

  @@index([phoneNumber])
  @@index([email])
  @@index([role])
  @@map("users")
}

enum UserRole {
  FARMER
  BUYER
  ADMIN
}

enum Language {
  ENGLISH
  AMHARIC
  OROMO
}

// Farmer Profile
model FarmerProfile {
  id              String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  farmName       String?
  farmLocation   String?
  latitude       Float?
  longitude      Float?
  verificationStatus VerificationStatus @default(PENDING)
  verificationDocuments String[] // Array of document URLs
  verifiedAt     DateTime?
  rating         Float    @default(0)
  totalRatings   Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("farmer_profiles")
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
  UNDER_REVIEW
}

// Buyer Profile
model BuyerProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  businessName  String?
  businessType  String?
  address       String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@map("buyer_profiles")
}

// Product/Listing Model
model Product {
  id            String      @id @default(uuid())
  farmerId      String
  farmer        User        @relation(fields: [farmerId], references: [id], onDelete: Cascade)
  title         String
  description   String?
  category      String
  price         Float
  quantity      Float
  minOrder      Float?
  unit          String      @default("kg")
  images        String[]    // Array of image URLs
  location      String
  latitude      Float?
  longitude     Float?
  status        ProductStatus @default(ACTIVE)
  syncStatus    SyncStatus  @default(SYNCED)
  rating        Float       @default(0)
  totalRatings  Int         @default(0)
  soldQuantity  Float       @default(0)
  views         Int         @default(0)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  // Relations
  orderItems    OrderItem[]
  reviews       Review[]

  @@index([farmerId])
  @@index([category])
  @@index([status])
  @@index([location])
  @@index([createdAt])
  @@index([price])
  @@index([rating])
  @@index([status, category])
  @@index([status, location])
  @@index([status, createdAt])
  @@map("products")
}

enum ProductStatus {
  ACTIVE
  INACTIVE
  SOLD_OUT
  DELETED
}

enum SyncStatus {
  SYNCED
  PENDING
  ONLINE_ONLY
}

// Order Model
model Order {
  id              String        @id @default(uuid())
  orderNumber     String        @unique
  buyerId         String
  buyer           User          @relation("BuyerOrders", fields: [buyerId], references: [id], onDelete: Cascade)
  farmerId        String
  farmer          User          @relation("FarmerOrders", fields: [farmerId], references: [id], onDelete: Cascade)
  status          OrderStatus   @default(PENDING)
  totalAmount     Float
  negotiatedPrice Float?        // Final negotiated price if different from product price
  deliveryAddress String
  deliveryLat     Float?
  deliveryLng     Float?
  deliveryDate    DateTime?
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Relations
  items           OrderItem[]
  payment         Payment?
  messages        Message[]
  reviews         Review[]

  @@index([buyerId])
  @@index([farmerId])
  @@index([status])
  @@index([orderNumber])
  @@index([createdAt])
  @@map("orders")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PAYMENT_PENDING
  PAID
  PROCESSING
  SHIPPED
  IN_TRANSIT
  DELIVERED
  CANCELLED
  DISPUTED
  REFUNDED
}

// Order Item
model OrderItem {
  id          String  @id @default(uuid())
  orderId     String
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product @relation(fields: [productId], references: [id], onDelete: Restrict)
  quantity    Float
  unitPrice   Float
  totalPrice  Float
  createdAt   DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// Payment Model with Escrow
model Payment {
  id              String        @id @default(uuid())
  orderId         String        @unique
  order           Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  amount          Float
  currency        String        @default("ETB")
  status          PaymentStatus @default(PENDING)
  paymentMethod   PaymentMethod
  escrowStatus    EscrowStatus  @default(HELD)
  escrowReleaseAt DateTime?     // Auto-release date
  transactionId   String?       @unique // External payment gateway transaction ID
  gatewayResponse Json?         // Full response from payment gateway
  paidAt          DateTime?
  releasedAt      DateTime?
  refundedAt      DateTime?
  refundReason    String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([orderId])
  @@index([status])
  @@index([escrowStatus])
  @@index([transactionId])
  @@map("payments")
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CHAPA
  TELEBIRR
  CBE_BIRR
  HELLO_CASH
  AMOLE
  BANK_TRANSFER
}

enum EscrowStatus {
  HELD
  RELEASED
  REFUNDED
  DISPUTED
}

// Review/Rating Model
model Review {
  id          String   @id @default(uuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  reviewerId  String
  reviewer    User     @relation("ReviewerReviews", fields: [reviewerId], references: [id], onDelete: Cascade)
  reviewedUserId String
  reviewedUser User    @relation("ReviewedUserReviews", fields: [reviewedUserId], references: [id], onDelete: Cascade)
  productId   String?
  product     Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  rating      Int      // 1-5 stars
  comment     String?
  isVerified  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([orderId, reviewerId]) // One review per order per reviewer
  @@index([reviewerId])
  @@index([reviewedUserId])
  @@index([productId])
  @@index([rating])
  @@map("reviews")
}

// Chat/Message Model
model Message {
  id          String      @id @default(uuid())
  orderId     String
  order       Order       @relation(fields: [orderId], references: [id], onDelete: Cascade)
  senderId    String
  sender      User        @relation("SenderMessages", fields: [senderId], references: [id], onDelete: Cascade)
  receiverId  String
  receiver    User        @relation("ReceiverMessages", fields: [receiverId], references: [id], onDelete: Cascade)
  content     String
  messageType MessageType @default(TEXT)
  isRead      Boolean     @default(false)
  attachments String[]    // Array of file URLs
  createdAt   DateTime    @default(now())

  @@index([orderId])
  @@index([senderId])
  @@index([receiverId])
  @@index([createdAt])
  @@map("messages")
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  PRICE_NEGOTIATION
  SYSTEM
}

// Notification Model
model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType
  title     String
  message   String
  data      Json?            // Additional data (orderId, productId, etc.)
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@index([userId])
  @@index([isRead])
  @@index([createdAt])
  @@map("notifications")
}

enum NotificationType {
  ORDER_PLACED
  ORDER_CONFIRMED
  ORDER_CANCELLED
  PAYMENT_RECEIVED
  PAYMENT_RELEASED
  ORDER_SHIPPED
  ORDER_DELIVERED
  REVIEW_RECEIVED
  MESSAGE_RECEIVED
  VERIFICATION_APPROVED
  VERIFICATION_REJECTED
  SYSTEM_ANNOUNCEMENT
}

// OTP Code Model
model OtpCode {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  phoneNumber String
  code        String
  purpose     OtpPurpose
  expiresAt   DateTime
  isUsed      Boolean  @default(false)
  createdAt   DateTime @default(now())

  @@index([phoneNumber])
  @@index([code])
  @@index([expiresAt])
  @@map("otp_codes")
}

enum OtpPurpose {
  REGISTRATION
  LOGIN
  PASSWORD_RESET
  PHONE_VERIFICATION
}

// Refresh Token Model
model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}
